default:
  image: python:3.12-slim
  before_script:
    - apt-get update
    - apt-get install --no-install-recommends -y libgl1-mesa-glx libglib2.0-dev
    - python --version ; pip --version
    - pip install poetry
    - poetry config virtualenvs.create false
    - poetry install
  retry: 2

stages:
  - lint
  - test
  - pre_commit

lint:
  stage: lint
  rules:
    - if: $CI_COMMIT_BRANCH != $CI_DEFAULT_BRANCH
      changes:
        paths:
          - "src/**"
        compare_to: "main"
  script:
    - poetry run flake8 src/

mypy:
  stage: lint
  rules:
    - if: $CI_COMMIT_BRANCH != $CI_DEFAULT_BRANCH
      changes:
        paths:
          - "src/**"
        compare_to: "main"
  script:
    - poetry run mypy src/

test:
  stage: test
  script:
    - poetry run pytest --cov
  rules:
    - if: $CI_COMMIT_BRANCH != $CI_DEFAULT_BRANCH

pre_commit:
  stage: pre_commit
  rules:
    - if: '$CI_PIPELINE_SOURCE == "merge_request_event"'
  script:
    - poetry run flake8 src/
    - poetry run mypy src/
    - poetry run pytest --cov
